#!/bin/bash

# This will not commit to user or redhat-appstudio, that step is manual.
# release process is to create a branch in your fork, or in the redhat-appstudio directly
# and copy the files into the relevant locations for that CI

TEMPLATES=./samples

echo "Updating Software Templates $TEMPLATES"

# Function that can update the tssc-templates folder for Multi-CI
# Templates use the ciType to copy the correct CI to the generated repos from the folder
# Locations are:
# Source CI  <template-repo>/skeleton/ci/source-repo/CI_TYPE
# GITOPS CI  <template-repo>/skeleton/ci/gitops-template/CI_TYPE
# CI type will be jenkins, gitlabci, githubactions
# Note. the .tekton directory in the repo is not generated from here
# arg1   root-ci (pass source or gitops here)
# arg2   ciType  - jenkins, gitlabci, githubactions
# arg3   rhtap env.sh file -- allows different defaults if you want for local test
# arg4   files-or-dir to copy to template dir (root-ci + ciType)
# WARNING - this will WIPE the CI directory and copy the files there
function update-tssc-templates() {
    ROOT_CI_LOCATION=$1
    CI_TYPE=$2
    RHTAP_ENV=$3
    TEMPLATE_FILES=$4
    SRC_FOLDER=$TEMPLATE_FILES/$CI_TYPE    # from generated folder CI_TYPE
    DEST_FOLDER=$ROOT_CI_LOCATION/$CI_TYPE # to template folder CI_TYPE

    echo "Updating $DEST_FOLDER from $SRC_FOLDER"
    rm -rf $DEST_FOLDER
    mkdir -p $DEST_FOLDER/tssc
    cp $RHTAP_ENV $DEST_FOLDER/tssc/env.sh
    cp -r $SRC_FOLDER/. $DEST_FOLDER
}

CI_ROOT_SRC=$TEMPLATES/skeleton/ci/source-repo
CI_ROOT_GITOPS=$TEMPLATES/skeleton/ci/gitops-template
GEN_SRC=generated/source-repo
GEN_GITOPS=generated/gitops-template

# templates are copied 1-1
for ciType in jenkins gitlabci githubactions azure; do
    update-tssc-templates $CI_ROOT_SRC $ciType tssc/env.template.sh $GEN_SRC
    update-tssc-templates $CI_ROOT_GITOPS $ciType tssc/env.template.sh $GEN_GITOPS
done

# only update env.sh for tekton
echo "Updating tekton env.sh"
rm -rf $CI_ROOT_SRC/tekton/tssc
mkdir -p $CI_ROOT_SRC/tekton/tssc
cp tssc/env.template.sh $CI_ROOT_SRC/tekton/tssc/env.sh

rm -rf $CI_ROOT_GITOPS/tekton/tssc
mkdir -p $CI_ROOT_GITOPS/tekton/tssc
cp tssc/env.template.sh $CI_ROOT_GITOPS/tekton/tssc/env.sh

echo
