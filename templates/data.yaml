---
runner_image: quay.io/redhat-appstudio/rhtap-task-runner:latest

build_steps:
  - name: init
    substeps: [init]
  - name: build
    substeps: [buildah-tssc, cosign-sign-attest]
  - name: deploy
    substeps: [update-deployment]
  - name: scan
    substeps: [acs-deploy-check, acs-image-check, acs-image-scan]
    concurrent: true
  - name: summary
    substeps: [show-sbom-rhdh, summary]
    concurrent: true

build_variables:
  - name: ROX_CENTRAL_ENDPOINT

  - name: GITOPS_AUTH_USERNAME
    if: '!isGitLab'
    commented_out: true
  - name: GITOPS_AUTH_USERNAME
    if: 'isGitLab'
  - name: GITOPS_AUTH_USERNAME
    if: 'isAzure'
    commented_out: true
    comment: "Uncomment this when using Bitbucket"

  - name: IMAGE_REGISTRY_USER
    if: 'isGitHub || isAzure || isJenkins'
    comment: "Set this to the user for your specific registry"
  - name: IMAGE_REGISTRY_USER
    if: '!isGitHub && !isAzure && !isJenkins'
    commented_out: true
    comment: "Set this to the user for your specific registry"

  # Expose Rekor and TUF in GitHub Actions so they can be set by user in secrets
  - name: REKOR_HOST
    if: 'isGitHub'
    comment: "Set this only when using an external Rekor instance"
  - name: TUF_MIRROR
    if: 'isGitHub'
    comment: "Set this only when using an external TUF instance"
  # Rekor and TUF again, but there is a difference between GH Actions and Jenkins
  - name: REKOR_HOST
    if: 'isJenkins'
  - name: TUF_MIRROR
    if: 'isJenkins'

  - name: QUAY_IO_CREDS_USR
    if: '!isJenkins'
    commented_out: true

  - name: ARTIFACTORY_IO_CREDS_USR
    if: '!isJenkins'
    commented_out: true

  - name: NEXUS_IO_CREDS_USR
    if: '!isJenkins'
    commented_out: true

  - name: COSIGN_PUBLIC_KEY
    if: 'isGitHub || isAzure || isJenkins'
    comment: Used to verify the image signature and attestation
  - name: COSIGN_PUBLIC_KEY
    if: '!isGitHub && !isAzure && !isJenkins'
    commented_out: true
    comment: Used to verify the image signature and attestation

  - name: CUSTOM_ROOT_CA
    if: 'isJenkins'
    comment: Custom Root CA to be used in scripts as trusted
    optional: true
    commented_out: true

  - name: CUSTOM_ROOT_CA
    if: '!isJenkins'
    comment: Custom Root CA to be used in scripts as trusted
    optional: true

build_secrets:
  - name: ROX_API_TOKEN

  - name: GITOPS_AUTH_USERNAME
    if: 'isAzure'
    commented_out: true
    comment: "Uncomment this when using Bitbucket"

  - name: GITOPS_AUTH_PASSWORD

  - name: IMAGE_REGISTRY_PASSWORD
    if: 'isGitHub || isAzure || isJenkins'
    comment: "Set this password for your specific registry"
  - name: IMAGE_REGISTRY_PASSWORD
    if: '!isGitHub && !isAzure && !isJenkins'
    commented_out: true
    comment: "Set this password for your specific registry"

  - name: QUAY_IO_CREDS
    if: isJenkins
    comment: "Default registry is set to quay.io"
  - name: QUAY_IO_CREDS_PSW
    if: '!isJenkins'
    commented_out: true

  - name: ARTIFACTORY_IO_CREDS
    if: isJenkins
    commented_out: true
  - name: ARTIFACTORY_IO_CREDS_PSW
    if: '!isJenkins'
    commented_out: true

  - name: NEXUS_IO_CREDS
    if: isJenkins
    commented_out: true
  - name: NEXUS_IO_CREDS_PSW
    if: '!isJenkins'
    commented_out: true

  - name: COSIGN_SECRET_PASSWORD
  - name: COSIGN_SECRET_KEY

gitops_steps:
  - name: Verify Conforma
    substeps: [gather-deploy-images, verify-conforma]
  - name: Upload SBOM
    substeps: [gather-images-to-upload-sbom, download-sbom-from-url-in-attestation, upload-sbom-to-trustification]

gitops_variables:
  - name: ROX_CENTRAL_ENDPOINT
    if: 'isJenkins'

  - name: COSIGN_PUBLIC_KEY
    if: 'isGitHub || isAzure || isJenkins'
    comment: Used to verify the image signature and attestation
  - name: COSIGN_PUBLIC_KEY
    if: '!isGitHub && !isAzure && !isJenkins'
    commented_out: true
    comment: Used to verify the image signature and attestation

  - name: TRUSTIFICATION_BOMBASTIC_API_URL
    if: 'isGitHub || isAzure || isJenkins'
    comment: URL of the BOMbastic api host (e.g. https://sbom.trustification.dev)
  - name: TRUSTIFICATION_BOMBASTIC_API_URL
    if: '!isGitHub && !isAzure && !isJenkins'
    commented_out: true
    comment: URL of the BOMbastic api host (e.g. https://sbom.trustification.dev)

  - name: TRUSTIFICATION_OIDC_ISSUER_URL
    if: 'isGitHub || isAzure || isJenkins'
    comment: URL of the OIDC token issuer (e.g. https://sso.trustification.dev/realms/chicken)
  - name: TRUSTIFICATION_OIDC_ISSUER_URL
    if: '!isGitHub && !isAzure && !isJenkins'
    commented_out: true
    comment: URL of the OIDC token issuer (e.g. https://sso.trustification.dev/realms/chicken)

  - name: TRUSTIFICATION_OIDC_CLIENT_ID
    if: 'isGitHub || isAzure || isJenkins'
  - name: TRUSTIFICATION_OIDC_CLIENT_ID
    if: '!isGitHub && !isAzure && !isJenkins'
    commented_out: true

  - name: TRUSTIFICATION_SUPPORTED_CYCLONEDX_VERSION
    if: 'isGitHub || isAzure || isJenkins'
  - name: TRUSTIFICATION_SUPPORTED_CYCLONEDX_VERSION
    if: '!isGitHub && !isAzure  && !isJenkins'
    commented_out: true

  # If the OCI registry is not public then ec needs some credentials so it can see the attestations.
  # Todo: Use different credentials here so we provide read access only instead of read/write access.
  # github always uses these
  - name: IMAGE_REGISTRY_USER
    if: 'isGitHub || isJenkins'
    comment: "Set this to the user for your specific registry"

  # Expose Rekor and TUF in GitHub Actions so they can be set by user in secrets
  - name: REKOR_HOST
    if: 'isGitHub'
    comment: "Set this only when using an external Rekor instance"
  - name: TUF_MIRROR
    if: 'isGitHub'
    comment: "Set this only when using an external TUF instance"
  # Rekor and TUF again, but there is a difference between GH Actions and Jenkins in comment
  - name: REKOR_HOST
    if: 'isJenkins'
  - name: TUF_MIRROR
    if: 'isJenkins'

  # other CIs in transition so comment out and leave Quay.io
  - name: IMAGE_REGISTRY_USER
    if: '!isGitHub & !isJenkins'
    commented_out: true
    comment: "Set this to the user for your specific registry"

  - name: QUAY_IO_CREDS_USR
    if: '!isJenkins'
    commented_out: true

  - name: ARTIFACTORY_IO_CREDS_USR
    if: '!isJenkins'
    commented_out: true

  - name: NEXUS_IO_CREDS_USR
    if: '!isJenkins'
    commented_out: true

gitops_secrets:
  - name: TRUSTIFICATION_OIDC_CLIENT_SECRET
  - name: IMAGE_REGISTRY_PASSWORD
    if: 'isGitHub || isAzure || isJenkins'
    comment: "Set this password for your specific registry"
  - name: IMAGE_REGISTRY_PASSWORD
    if: '!isGitHub && !isAzure && !isJenkins'
    commented_out: true
    comment: "Set this password for your specific registry"
  # show all the values options in the jenkins file and other CIs
  # this gives users a way to know what to set. Not perfect but better
  # to be documented
  - name: QUAY_IO_CREDS
    if: isJenkins
  - name: QUAY_IO_CREDS_PSW
    if: '!isJenkins'
    commented_out: true
  - name: ARTIFACTORY_IO_CREDS
    if: isJenkins
    commented_out: true
  - name: ARTIFACTORY_IO_CREDS_PSW
    if: '!isJenkins'
    commented_out: true
  - name: NEXUS_IO_CREDS
    if: isJenkins
    commented_out: true
  - name: NEXUS_IO_CREDS_PSW
    if: '!isJenkins'
    commented_out: true
  - name: COSIGN_SECRET_PASSWORD
    if: 'isJenkins'
  - name: COSIGN_SECRET_KEY
    if: 'isJenkins'
  - name: ROX_API_TOKEN
    if: 'isJenkins'
  - name: GITOPS_AUTH_PASSWORD
    if: 'isJenkins'
