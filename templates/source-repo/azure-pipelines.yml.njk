{%- include "do-not-edit.njk" -%}
{%- set secrets = build_secrets -%}

pr: none

trigger:
  - main

# Using self-hosted 'Default' agent pool by default
# Change accordingly when using a different agent pool
# Can be deleted if self-hosted agents are not being used
# See https://learn.microsoft.com/en-us/azure/devops/pipelines/agents/agents
pool:
  name: Default

container:
  image: quay.io/redhat-appstudio/rhtap-task-runner:latest
  options: --privileged

# Using 'tssc' variable group by default
# Change accordingly when using a different variable group
# Can be deleted if the variables are set differently
# See https://learn.microsoft.com/en-us/azure/devops/pipelines/process/variables
variables:
  - group: tssc
  - name: CI_TYPE
    value: azure

steps:
{%- filter indent(2) -%}
{%- for step in build_steps %}
{% include "azure-step.njk" %}
{%- endfor -%}
{%- endfilter %}
  - bash: |
      echo "â€¢ cleanup agent storage"
      echo "Disk usage before cleanup:"
      df -h
      echo "Cleaning directory: $(Agent.WorkFolder)"
      cd $(Agent.HomeDirectory)
      rm -rf $(Agent.WorkFolder)/*
      echo "Running Docker prune targeting images older than 12h"
      docker system prune -af --filter "until=12h"
      echo "Disk usage after cleanup:"
      df -h
    name: cleanup
    condition: always()
